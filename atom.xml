<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ioo0s&#39;s blog</title>
  
  
  <link href="http://ioo0s.art/atom.xml" rel="self"/>
  
  <link href="http://ioo0s.art/"/>
  <updated>2023-02-07T07:44:51.282Z</updated>
  <id>http://ioo0s.art/</id>
  
  <author>
    <name>ios</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Note</title>
    <link href="http://ioo0s.art/2023/02/07/Note/"/>
    <id>http://ioo0s.art/2023/02/07/Note/</id>
    <published>2023-02-07T07:18:26.000Z</published>
    <updated>2023-02-07T07:44:51.282Z</updated>
    
    <content type="html"><![CDATA[<h2 id="开博原因"><a href="#开博原因" class="headerlink" title="开博原因"></a>开博原因</h2><p>最近突然想分享几篇好玩的文章，尝试在csdn中发布（涂省事），但频繁提示我审核失败最终选择重新开一下博客，后续不定期更新😆😆😆</p><h2 id="历史博客"><a href="#历史博客" class="headerlink" title="历史博客"></a>历史博客</h2><p>有几篇还不错的历史文章，但因为原文.md丢失的原因在这里贴一下之前发布的链接</p><p><a href="https://blog.csdn.net/yinxuanwl/article/details/104583615">ios逆向入门笔记（详细到哭）</a></p><p><a href="https://blog.csdn.net/yinxuanwl/article/details/93474278">Reveal调试笔记</a></p><p><a href="https://blog.csdn.net/yinxuanwl/article/details/107724670">ios逆向入门笔记-HOOK-QQ登录</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;开博原因&quot;&gt;&lt;a href=&quot;#开博原因&quot; class=&quot;headerlink&quot; title=&quot;开博原因&quot;&gt;&lt;/a&gt;开博原因&lt;/h2&gt;&lt;p&gt;最近突然想分享几篇好玩的文章，尝试在csdn中发布（涂省事），但频繁提示我审核失败最终选择重新开一下博客，后续不定期更新😆</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>利用VMware获取shell-进阶</title>
    <link href="http://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/"/>
    <id>http://ioo0s.art/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/</id>
    <published>2023-02-07T02:24:18.000Z</published>
    <updated>2023-02-07T02:31:15.820Z</updated>
    
    <content type="html"><![CDATA[<h2 id="解包"><a href="#解包" class="headerlink" title="解包"></a>解包</h2><pre><code>gzip -d rootfs.gzsudo cpio -idmv &lt; ./rootfssudo chroot . /sbin/xz --check=sha256 -d /bin.tar.xzsudo chroot . /sbin/ftar -xf /bin.tar</code></pre><h2 id="Patch-init-文件"><a href="#Patch-init-文件" class="headerlink" title="Patch init 文件"></a>Patch init 文件</h2><p>文件所在位置 <code>/bin/init</code> ,注意这个是解包后才能拿到的文件</p><p>patch 位置在 <code>0x04518E5</code></p><span id="more"></span><p><strong>将</strong><strong>jnz loc_451BB4</strong><strong> 改为 </strong><strong>jz loc_451BB4 </strong></p><p>下图是 patch 后的</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnp12KkCPJsgrJoFZ8uaZX15.png"></p><p>伪代码</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnPKVLs7SFq7xOzvSBaOiSTd.png"></p><p>另外一处也需要 patch</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnWZnG85SRFKyyydsEcCbI8b.png"></p><p>修改前</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnbIEedUGu0ily5S5emt7sL2.png"></p><p>修改后</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnwP6k0sGEU7X8Vi7zbcJHZc.png"></p><p>导出后替换原来的./bin/init 文件</p><h2 id="Patch-shell"><a href="#Patch-shell" class="headerlink" title="Patch shell"></a>Patch shell</h2><ol><li>下载编译 busybox</li></ol><p>下载地址：<a href="https://busybox.net/downloads/">https://busybox.net/downloads/</a></p><ol><li>预编译配置</li></ol><pre><code>make menuconfig</code></pre><ol><li>修改配置信息</li></ol><ul><li>Build Options —&gt; 选择[*] Build Busybox as a static binary（no shared libs）</li><li>去掉 Coreutils—&gt;sync 选项</li></ul><ol><li>编译</li></ol><pre><code>make make install</code></pre><p>编译成功 busybox 文件会在 <code>./_install/bin/busybox</code></p><ol><li>复制 busybox 到 rootfs 的/bin 目录下</li></ol><pre><code>cp ../busybox/busybox-1.35.0/_install/bin/busybox ./bin/chmod 777 ./bin/busybox</code></pre><ol><li>删除原 sh 软链并创建 busybox 软链</li></ol><pre><code>rm -rf ./bin/shls -n /bin/busybox sh</code></pre><h2 id="后门制作"><a href="#后门制作" class="headerlink" title="后门制作"></a>后门制作</h2><p>编译一段命令执行的 elf 文件，采用静态链接,这里最好使用 system 而不是 execv，因为 system 会附加 init 后的环境，execv 不会。前两条用于测试 busybox 是否正常，后一条用于添加个 shell</p><pre><code>#include &lt;stdio.h&gt;int tcp_port = 22;char *ip = &quot;192.168.109.143&quot;;void shell()&#123;                        system(&quot;/bin/busybox ls&quot;, 0, 0);        system(&quot;/bin/busybox id&quot;, 0, 0);        system(&quot;/bin/busybox killall sshd &amp;&amp; /bin/busybox telnetd -l /bin/sh -b 0.0.0.0 -p 22&quot;, 0, 0);        return;&#125;int main(int argc, char const *argv[])&#123;        shell();        return 0;&#125;</code></pre><p>编译</p><pre><code>gcc -g shell.c -static -o shell</code></pre><h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><pre><code>sudo chroot . /sbin/ftar -cf bin.tar ./binsudo chroot . /sbin/xz --check=sha256 -e bin.tarsu rootfind . -path &#39;./bin&#39; -prune -o -print |cpio -H newc -o &gt; ../make/rootfs.rawcd ../makecat rootfs.raw | gzip &gt; rootfs.gz</code></pre><h2 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h2><p>使用新虚拟机挂载当前 fortigate 的虚拟磁盘，<code>添加-&gt;现有虚拟磁盘</code>。</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnapM1bapHSvqn0lW4C9yKrb.png"></p><p>启动该虚拟机后，搜索应用 disk，选择对应大小的虚拟机磁盘，这里是 2G 的，然后选择启动挂载</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcn7WU2xW82Oj1p5Hbwnay0pc.png"></p><p>替换 rootfs.gz 文件</p><pre><code>sudo sucp path/to/rootfs.gz ./</code></pre><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnUsHHryGKKYw1ESbN0QQQic.png"></p><p>关闭挂载或者挂起虚拟机</p><h2 id="GDB-内核-Patch"><a href="#GDB-内核-Patch" class="headerlink" title="GDB 内核 Patch"></a>GDB 内核 Patch</h2><p>绕过 fgt_verify，需要绕过下方跳转 jnz，可以在此处下断点并修改 rax=0 绕过</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcn5sAHD8KFpwProizAdJzQef.png"></p><p>配置 vm 调试<a href="./%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell.md">利用VMware获取shell</a></p><pre><code>gdbpwndbg&gt; file /home/ios/Fortigate/vmlinuz_elfpwndbg&gt; b*0xFFFFFFFF807AC11Cpwndbg&gt; target remote 192.168.109.1:12345pwndbg&gt; c</code></pre><p>这里讲解一个技巧：什么时候执行 <code>target remote 192.168.109.1:12345</code> 下断，由于我们要 patch 的是 vmlinuz 中的验证，所以需要在屏幕输出 <code>Bootting the kernel</code> 后 1-2 秒再执行，如下图</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcn7xNskTYXxPLewpZI9qYZgh.png"></p><p>触发断点</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnBipQCMHQH0iaVktQHTemDe.png"></p><p>修改 rax=0</p><pre><code>set $rax=0</code></pre><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnStvMa3M1EAJ5EPzp81Pijd.png"></p><p>测试能成功运行启动</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcn9KGAaBQA5ul9xowbeeWnEe.png"></p><h2 id="运行到-shell"><a href="#运行到-shell" class="headerlink" title="运行到 shell"></a>运行到 shell</h2><p>登录到 cli，执行 <code>diag hardware smartctl</code></p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnzkFMwkKiJ46wEidtckK0Yc.png"></p><p>查看结果</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnd0fwycUWKwy9OLeWct0ozb.png"></p><p>尝试用 telnet 连接后门，注意端口是 22！！！！需要指定一下端口</p><pre><code>telnet 192.168.109.111 22</code></pre><p>这里的 ip 是在 cli 中配置后的，可以参考基础配置文章</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnurjgBpjiLl8gmglgbyGXoh.png"></p><p>注意：获取 shell 后还需要借助 busybox 来执行其他命令，如图，直接执行会找不到软链</p><h2 id="遇到问题"><a href="#遇到问题" class="headerlink" title="遇到问题"></a>遇到问题</h2><h3 id="EDD：Error-0400-reading-sector"><a href="#EDD：Error-0400-reading-sector" class="headerlink" title="EDD：Error 0400 reading sector"></a>EDD：Error 0400 reading sector</h3><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnHOHJZiPH1zqyAitv9rD4Oc.png"></p><h4 id="造成原因"><a href="#造成原因" class="headerlink" title="造成原因"></a>造成原因</h4><p>使用 windows 下的 diskgenius 替换 rootfs 导致</p><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>使用另一台 linux 虚拟机 挂载虚拟磁盘，并复制进去</p><h3 id="偶尔出现-cpio-打包-blocks-打包前后不相同的问题"><a href="#偶尔出现-cpio-打包-blocks-打包前后不相同的问题" class="headerlink" title="偶尔出现 cpio 打包 blocks 打包前后不相同的问题"></a>偶尔出现 cpio 打包 blocks 打包前后不相同的问题</h3><h3 id="同上-该问题会导致虚拟机启动后-无任何提示-无限重启"><a href="#同上-该问题会导致虚拟机启动后-无任何提示-无限重启" class="headerlink" title="同上 该问题会导致虚拟机启动后 无任何提示 无限重启"></a>同上 该问题会导致虚拟机启动后 无任何提示 无限重启</h3><h4 id="造成原因-1"><a href="#造成原因-1" class="headerlink" title="造成原因"></a>造成原因</h4><p>在 vmlinuz 中存在一处 fgtsum 校验,具体位置在 <code>0xFFFFFFFF807AC117</code> 。</p><p><img src="/2023/02/07/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell-%E8%BF%9B%E9%98%B6/boxcnPqwpD4h8M029MQkMiPh9Kc.png"></p><h4 id="解决方法-1"><a href="#解决方法-1" class="headerlink" title="解决方法"></a>解决方法</h4><p>在 <code>0xFFFFFFFF807AC117</code> 处下断，用 gdb 修改 eax 值为 0，即可绕过验证</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;解包&quot;&gt;&lt;a href=&quot;#解包&quot; class=&quot;headerlink&quot; title=&quot;解包&quot;&gt;&lt;/a&gt;解包&lt;/h2&gt;&lt;pre&gt;&lt;code&gt;gzip -d rootfs.gz
sudo cpio -idmv &amp;lt; ./rootfs
sudo chroot . /sbin/xz --check=sha256 -d /bin.tar.xz
sudo chroot . /sbin/ftar -xf /bin.tar
&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;Patch-init-文件&quot;&gt;&lt;a href=&quot;#Patch-init-文件&quot; class=&quot;headerlink&quot; title=&quot;Patch init 文件&quot;&gt;&lt;/a&gt;Patch init 文件&lt;/h2&gt;&lt;p&gt;文件所在位置 &lt;code&gt;/bin/init&lt;/code&gt; ,注意这个是解包后才能拿到的文件&lt;/p&gt;
&lt;p&gt;patch 位置在 &lt;code&gt;0x04518E5&lt;/code&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="基础知识" scheme="http://ioo0s.art/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    
    
    <category term="IOT" scheme="http://ioo0s.art/tags/IOT/"/>
    
    <category term="FortiGate" scheme="http://ioo0s.art/tags/FortiGate/"/>
    
  </entry>
  
  <entry>
    <title>利用VMware获取shell</title>
    <link href="http://ioo0s.art/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/"/>
    <id>http://ioo0s.art/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/</id>
    <published>2023-02-06T05:46:36.000Z</published>
    <updated>2023-02-07T02:20:12.153Z</updated>
    
    <content type="html"><![CDATA[<h2 id="获取-vmlinuz"><a href="#获取-vmlinuz" class="headerlink" title="获取 vmlinuz"></a>获取 vmlinuz</h2><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><p>对于 vmdk 没有加密的虚拟设备来说，可以直接通过挂载磁盘的方式提取出 vmlinuz 文件，但是要注意磁盘中的内核文件命名可能不同！！！</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcn2cjTeNLk3cdxSy6yrkdxef.png"></p><span id="more"></span><p>使用 DiskGenius 挂载虚拟磁盘，通过寻找 vmlinuz 文件的特征信息来确定具体文件</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcn2BG3thFFguLDkrSTwqWYec.png"></p><p>一般情况 vmlinuz 文件头部 会含有上图中的字符串信息，或者通过头标识符也可以判断文件，所以 flatkc 就是该环境中的 vmlinuz 文件，右键导出即可。</p><p>使用工具 <a href="https://github.com/marin-m/vmlinux-to-elf">vmlinux-to-elf</a> 可以将内核文件转换为 elf 文件，方便我们接下来的逆向分析。</p><p><strong>注意：请不要用该方法得到的 rootfs.gz 直接解压使用，否则后期打包时会出现问题！！！</strong></p><h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><p>将虚拟磁盘挂载到其他虚拟机中，并启动虚拟机</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnqDzrAcy5Krj2XG5AtXfIYf.png"></p><p>搜索并打开 <code>disk</code> 应用</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnrSJtNfKhxmlPUYySXku1fb.png"></p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnxDdp9wGX6NZjcGaHH1KPUd.png"></p><p>找到新添加的硬盘后，点击启动按钮，接着硬盘会被挂载，进而得到 rootfs 和 vmlinuz</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnOVM9ShpKe6aUI4bRyywlde.png"></p><h2 id="寻找断点函数"><a href="#寻找断点函数" class="headerlink" title="寻找断点函数"></a>寻找断点函数</h2><p>加载 vmlinux_elf 文件到 ida 中进行分析。</p><p>通常 vmlinuz 初始化流程中最后一步，内核会执行 init_post 函数。其中在该函数中最终会执行/sbin/init。</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnbwMuK4CGzX6yDzpIb9PuEf.png"></p><p>记录该函数地址 <code>FFFFFFFF807AC0E9</code> ,为了接下来调试做准备</p><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcnCjVKc5j2byi1YAp9jxrcWh.png"></p><h2 id="配置-vm-调试信息"><a href="#配置-vm-调试信息" class="headerlink" title="配置 vm 调试信息"></a>配置 vm 调试信息</h2><pre><code>debugStub.listen.guest64 = &quot;TRUE&quot;debugStub.listen.guest64.remote = &quot;TRUE&quot;debugStub.port.guest64 = &quot;12345&quot;debugStub.listen.guest32 = &quot;TRUE&quot;debugStub.listen.guest32.remote = &quot;TRUE&quot;debugStub.port.guest32 = &quot;12346&quot;</code></pre><p><img src="/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcn54fRCjoOOehEJ0l7llpG6e.png"></p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;获取-vmlinuz&quot;&gt;&lt;a href=&quot;#获取-vmlinuz&quot; class=&quot;headerlink&quot; title=&quot;获取 vmlinuz&quot;&gt;&lt;/a&gt;获取 vmlinuz&lt;/h2&gt;&lt;h3 id=&quot;方式一&quot;&gt;&lt;a href=&quot;#方式一&quot; class=&quot;headerlink&quot; title=&quot;方式一&quot;&gt;&lt;/a&gt;方式一&lt;/h3&gt;&lt;p&gt;对于 vmdk 没有加密的虚拟设备来说，可以直接通过挂载磁盘的方式提取出 vmlinuz 文件，但是要注意磁盘中的内核文件命名可能不同！！！&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2023/02/06/%E5%88%A9%E7%94%A8VMware%E8%8E%B7%E5%8F%96shell/boxcn2cjTeNLk3cdxSy6yrkdxef.png&quot;&gt;&lt;/p&gt;</summary>
    
    
    
    <category term="基础知识" scheme="http://ioo0s.art/categories/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"/>
    
    
    <category term="IOT" scheme="http://ioo0s.art/tags/IOT/"/>
    
    <category term="FortiGate" scheme="http://ioo0s.art/tags/FortiGate/"/>
    
  </entry>
  
  <entry>
    <title>王铲铲的致富之路-逆向分析</title>
    <link href="http://ioo0s.art/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/"/>
    <id>http://ioo0s.art/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/</id>
    <published>2023-02-06T03:10:52.000Z</published>
    <updated>2023-02-06T06:11:08.190Z</updated>
    
    <content type="html"><![CDATA[<h2 id="游戏介绍"><a href="#游戏介绍" class="headerlink" title="游戏介绍"></a>游戏介绍</h2><p>版本：1.2.4<br>设备：xsmax<br>游戏环境：Unity</p><span id="more"></span><h3 id="游戏玩法"><a href="#游戏玩法" class="headerlink" title="游戏玩法"></a>游戏玩法</h3><p>看着他挖，但是你需要钱去升级设备、场子等等，总之有钱！这个游戏就是你的天下！！！</p><p>游戏不需要额外充钱，但是会一直有广告</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnJ17FucdZKSiH6x0ChWdZQd.png"></p><h2 id="逆向过程"><a href="#逆向过程" class="headerlink" title="逆向过程"></a>逆向过程</h2><h3 id="砸壳"><a href="#砸壳" class="headerlink" title="砸壳"></a>砸壳</h3><p>获取未加密APP</p><h4 id="砸壳环境"><a href="#砸壳环境" class="headerlink" title="砸壳环境"></a>砸壳环境</h4><ol><li>实体机 xsmax 系统版本 14.8 已经越狱</li><li>Mac os 环境 需要装<strong>usbmuxd</strong><strong>，</strong><em>Windows 下没找到能解决该问题的方法</em></li><li>均安装 frida 同一版本就行</li><li>Frida-ios-dump</li></ol><h4 id="开始砸壳"><a href="#开始砸壳" class="headerlink" title="开始砸壳"></a>开始砸壳</h4><ol><li>确保 frida 能正常连通</li></ol><p>使用 usb 连接手机设备，使用命令 <code>frida-ps -U</code> 该命令用于查看 USB 连接设备当前运行的进程。</p><p>待补充图</p><ol><li>使用 iproxy 命令转发 22 端口，<code>iproxy 2222 22</code></li></ol><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcn0RZDt8j3nK46J3dKip84Le.png"></p><ol><li>修改 Frida-ios-dump 脚本中的 root 密码</li><li>输入命令 <code>python dump.py -l</code> 列出当前设备中的应用程序</li></ol><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcncd3lDAxThVjkRnfRXbvT7e.png"></p><ol><li>输入命令 <code>python dump.py com.mojike.digearth</code> ，开始砸壳</li></ol><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnBdRrzbav42e0hDHn1Stvx1.png"></p><h3 id="解包分析"><a href="#解包分析" class="headerlink" title="解包分析"></a>解包分析</h3><p>复制 dump 中的 ipa 文件到 Windows 下，进行下一步分析。</p><p>首先重命名.ipa 为.zip 并解压</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnag2Z25uOhh6sj96vHGjINe.png"></p><p>简单说明一下重要的目录结构，该游戏是 Unity 开发。</p><h4 id="Data-目录"><a href="#Data-目录" class="headerlink" title="Data 目录"></a>Data 目录</h4><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnqU56Sk9q7lCmgiS47dD58f.png"></p><p><code>data.unity3d</code> 文件是游戏的资源文件，可以通过 <code>AssetStudio.net6</code>  或者 <code>AssetRipper_win_x64</code> 进行查看或者分析</p><p><code>RaW</code> 文件夹里面放着一些分享时的图片资源</p><p><code>Managed</code> 文件夹放着 ll2cpp 生成后的文件 非常重要！！！</p><p><code>mono</code> 放着数据库相关文件</p><h4 id="Frameworks-目录"><a href="#Frameworks-目录" class="headerlink" title="Frameworks 目录"></a>Frameworks 目录</h4><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnyfJ63JIN5VypLEzOF4uMwb.png"></p><p><code>UnityFramework.framework</code> 里面放着游戏编译后的 object-c 程序 很重要</p><p><code>KSAdSDK.framework</code> 广告框架，没有详细 研究</p><p><code>TTNetworkManager.framework</code> 网络相关，没有详细研究</p><h3 id="ll2cpp-反编译"><a href="#ll2cpp-反编译" class="headerlink" title="ll2cpp 反编译"></a>ll2cpp 反编译</h3><p>利用 <code>Il2CppDumper-net6-v6.7.25 </code> 进行反编译</p><p><strong>可执行文件位置</strong></p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnPDeYAgcm7Zt8BWMEW6Mbtc.png"></p><p>符号表数据位置 <code>global-metadata.dat</code></p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnSVoilDB8tTBfvFls9MAnvb.png"></p><p>反编译后的数据信息</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnEYnzNfzvqp6n1wPbWL1mYf.png"></p><p>其中 stringliteral.json 是字符串表信息，包含着游戏字符串和对应偏移地址，il2cpp.h 是 object-c 的结构体信息</p><p>dump.cs 是.net 反编译后的源码信息，DummyDll 中包含的是提取出来的所有游戏 DLL 信息与 dump.cs 内容一致。</p><h3 id="逆向分析主程序"><a href="#逆向分析主程序" class="headerlink" title="逆向分析主程序"></a>逆向分析主程序</h3><p>首先通过 ida 打开程序</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcniqSbnOWZcULEuB3k3HwGeg.png"></p><p>接着利用脚本导入之前得到的 il2cpp.h 文件，和字符串文件信息</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnoXIzcO49IjqQ8GIovJC9qh.png"></p><p>这几个都可以导入，等待 20-30 分钟（函数量非常大！！）</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcndmfo2D6CT5zJ6psKdIOfMg.png"></p><p>接着就能看到 字符串已经可以分析出来了，函数名称也已经恢复，接着通过字符串文件，搜索我们的需求 `<strong>钱！！！！</strong></p><p>通过关键字 <code>money</code> 、<code>coin</code> 搜索到一个关键信息</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnSEqS3Y2DVAz35ebdDAKWfh.png"></p><p>ida 中输入 g，复制地址跳转</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcntjU2nDRNbOY7PzxaZQTG7d.png"></p><p>发现有几个函数引用了该字符串，get_GameCoin、set_GameCoin，因为目的是要改钱，所以 set 对我们更重要</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcn2Kno7Ua0UpgaVKRcbDnwjc.png"></p><p>根据 value 进行设置，看看哪里用了 set</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnAyS6owBybEtXazcymb3QBh.png"></p><p>发现有 CostCoin 函数和 AddCoin 函数都用到了该函数，所以这里有两种改法，一个是修改 AddCoin 时设置钱的数量，一个是修改花费时不扣钱。</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnKkHB5rmPAMzZB5mVkiGJvg.png"></p><p>可以看到增加钱的逻辑，是查询现有的钱然后加上获得的钱，这里修改的话就会造成一个问题！！！初始化的时候钱为 0.不太好改动，所以我打算改动了花费处</p><p><img src="/sboxcnPkalcvB4EGjGtobm8QO1Lg.png"></p><p>可以看到，我把花费时应该-coin 的位置改成了 +coin，这样的话每次花钱都会价钱，达到了一个修改金钱的目的</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnHQ0fZiEBkztENJWLUvNRpd.png"></p><p>改法比较简单，把原本 FSUB 改成 FADD 就可以了，除了钱还有个新出的模式 月球模式</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnMw4S8i3IwH7yPhVMPaKXie.png"></p><p>这个也是一种钞票，我们用同样的方式进行逆向</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnHHYqNfT6fSCBfILVSgOkue.png"></p><p>又看到熟悉的 ADD 和 Cost，同样减改成加</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcngxewsshIQZWUU7WVuc2bre.png"></p><p>改法相同 FSUB 改成 FADD</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnOqTyizqMdPAhYZDUwHZZtf.png"></p><h2 id="打包重签名"><a href="#打包重签名" class="headerlink" title="打包重签名"></a>打包重签名</h2><p>这个过程方法有太多太多，这里为了能尽快玩上游戏，我们就走最朴实无华的路线。</p><p>首先将 patched 后的游戏文件替换掉原本的文件</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcn85zIE4jPqwOQpFs34t50vc.png"></p><p>把该文件复制到对应位置，并且进入这个位置，右键压缩文件</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcn4va9IAGB96jX3K2ALaCv4d.png"></p><p>压缩后，重命名 Payload.zip 为 Payload.ipa</p><p>打开爱思助手！！！，使用里面的签名工具</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcniyY5OAGkwqvNpc8dQirz7c.png"></p><p>签名完成后，就能安装使用了</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcn468hrv1wyvIDPVhopTFDBd.png"></p><p>安装即可</p><p><img src="/2023/02/06/%E7%8E%8B%E9%93%B2%E9%93%B2%E7%9A%84%E8%87%B4%E5%AF%8C%E4%B9%8B%E8%B7%AF-%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/boxcnmoH9OE4T9C8bGEJGfmlC7g.png"></p><h2 id="成功截图"><a href="#成功截图" class="headerlink" title="成功截图"></a>成功截图</h2>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;游戏介绍&quot;&gt;&lt;a href=&quot;#游戏介绍&quot; class=&quot;headerlink&quot; title=&quot;游戏介绍&quot;&gt;&lt;/a&gt;游戏介绍&lt;/h2&gt;&lt;p&gt;版本：1.2.4&lt;br&gt;设备：xsmax&lt;br&gt;游戏环境：Unity&lt;/p&gt;</summary>
    
    
    
    <category term="逆向工程" scheme="http://ioo0s.art/categories/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B/"/>
    
    
    <category term="ios逆向" scheme="http://ioo0s.art/tags/ios%E9%80%86%E5%90%91/"/>
    
    <category term="游戏破解" scheme="http://ioo0s.art/tags/%E6%B8%B8%E6%88%8F%E7%A0%B4%E8%A7%A3/"/>
    
  </entry>
  
</feed>
